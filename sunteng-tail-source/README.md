# TailSource
----

flume的`SpoolDirectorySource`会自动把完成的文件重命名, 不适合现在nginx的日志滚动特征

TailSource 适合收集的日志文件特性是:  
固定对单个文件写日志, 滚动方式为先mv到其他地方, 再重新往文件路径写文件

沿用`SpoolDirectorySource`持久化方式, 每次处理完成后会有commit操作, commit操作会往磁盘append数据信息
meta文件会在每次commit的时候增加体积，在日志文件滚动的时候会删除meta文件重新生成一个(compact)

如果需要监控多个文件，可以开启多个TailSource.

## 参数说明:
---

| 参数             | 说明                                             | 默认值                     |
|------------------|--------------------------------------------------|----------------------------|
| filePath         | 指定要收集的日志文件路径，支持文件名使用星号匹配 | 无                         |
| deserializer     |                                                  | LINE                       |
| batchSize        | 一个事务批量处理的日志行数                       | 100                        |
| maxBackoff       |                                                  | 4000                       |
| inputCharset     | 文件编码                                         | UTF-8                      |
| metaDirectory    | 储存记录信息的目录(已处理文件列表、当前文件信息) | .                          |
| rateLimit        | 限速配置文件路径                                 | /etc/flume_rate_limit.conf |
| rateLimitRefresh | 拉取更新配置文件的时间间隔(单位：秒)             | 60                         |
| scanOnBegin      | 第一次扫描时是否从头开始                         | false                      |

## 元信息

在元信息目录下，会有对应不同的filePath会有三种元信息文件

* `{base64(filePath)}.cleanlock`  
  cleanlock 的作用是识别 TailSource 是否第一次运行，如果是 scanOnBegin 起作用

* `{base64(filePath)}.meta`  
  记录当前文件的位置信息，记录的元信息包涵了: 跟踪文件Inode Number, 路径，还有位置信息

* `{base64(filePath)}.marker`  
  记录哪些文件列表已经处理完成。另外会有一个一天启动一次的清扫任务，将记录在里面的文件路径并且该文件已经不存在(被删除)进行移除

## 限速配置文件内容
---

1. 流量限制支持的单位：B(不带b也表示b), kB, mB, gB, 0 表示不限速
2. 支持指定固定时段，00:00~12:00, 表示每天都按照该时段规则执行
3. 支持指定特定时间范围，2015/07/30.00:00~2015/07/30.23:00
4. 规则以行为单位分割，每行满足格式 `<date>~<date>=<limit>`, 比如：`00:00~12:00=1gb`
5. 两种时间表示方式不能混用, 时间范围如果是反方向的不生效, 比如: `23:00~00:00`, 应该是 `23:00~23:59`
6. 当多条规则的时间范围重合时，配置文件后面的配置会覆盖前面的配置
7. 如果时间范围没有被覆盖到，表示不限速
8. 限速规则作用于单个source，而不是总体流量，默认全部source会读取同一个文件。

### 例子：
```
00:00 ~ 18:00 = 0
20:00 ~ 23:59 = 10mb
2015/07/30.20:00 ~ 2015/08/01.12:00 = 1mb
2015/08/01.00:00 ~ 2015/08/01.12:00 = 0
```
* 2015/07/29.20:00时，10mb
* 2015/07/30.01:00时，不限速
* 2015/07/30.20:00时，1mb
* 2015/08/01.00:00时，不限速
* 2015/08/01.20:00时，10mb

> 当要批量临时设置多台机器，可以通过批量执行  
> `echo "2015/08/01.00:00 ~ 2015/08/01.12:00 = 1mb" >> /etc/flume_rate_limit.conf`  
> 当要取消时再批量设置回去  

